console.log("录音助手 Background Script 已加载");chrome.runtime.onInstalled.addListener(e=>{console.log("扩展已安装:",e),chrome.storage.local.set({voiceRecorderData:{recordings:[],settings:{audioQuality:"high",maxRecordingTime:300,autoSave:!0,showNotifications:!0}},installTime:Date.now()}),chrome.contextMenus.create({id:"voice-recorder-menu",title:"录音助手",contexts:["all"]}),chrome.contextMenus.create({id:"start-recording",title:"开始录音",contexts:["page"],parentId:"voice-recorder-menu"}),chrome.contextMenus.create({id:"open-recorder",title:"打开录音助手",contexts:["page"],parentId:"voice-recorder-menu"})});chrome.contextMenus.onClicked.addListener((e,t)=>{switch(e.menuItemId){case"start-recording":chrome.tabs.sendMessage(t.id,{type:"START_RECORDING_FROM_CONTEXT"}).catch(()=>{chrome.action.openPopup()});break;case"open-recorder":chrome.action.openPopup();break}});chrome.runtime.onMessage.addListener((e,t,r)=>{switch(console.log("Background 收到消息:",e),e.type){case"SHOW_NOTIFICATION":i(e.title,e.message,e.iconUrl),r({success:!0});break;case"GET_EXTENSION_INFO":return c().then(r),!0;case"DOWNLOAD_RECORDING":return s(e.blob,e.filename).then(r),!0;case"OPEN_OPTIONS":chrome.runtime.openOptionsPage(),r({success:!0});break;case"GET_ACTIVE_TAB":return a().then(r),!0;default:r({error:"Unknown message type"})}});chrome.tabs.onUpdated.addListener((e,t,r)=>{t.status==="complete"&&r.url&&(console.log("标签页更新:",r.url),l(e,r.url))});chrome.tabs.onActivated.addListener(e=>{console.log("标签页激活:",e.tabId)});async function c(){try{const e=chrome.runtime.getManifest(),t=await chrome.storage.local.get(["installTime"]);return{name:e.name,version:e.version,installTime:t.installTime}}catch(e){return console.error("获取插件信息失败:",e),{error:e.message}}}async function a(){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return{tab:e}}catch(e){return console.error("获取活动标签页失败:",e),{error:e.message}}}async function s(e,t){try{const r=new Blob([new Uint8Array(e)],{type:"audio/webm"}),o=URL.createObjectURL(r),n=await chrome.downloads.download({url:o,filename:t,saveAs:!1});return setTimeout(()=>{URL.revokeObjectURL(o)},1e3),{success:!0,downloadId:n}}catch(r){return console.error("下载失败:",r),{error:r.message}}}function i(e,t,r="icons/icon48.png"){chrome.notifications.create({type:"basic",iconUrl:r,title:e,message:t})}async function l(e,t){if(t.startsWith("http://")||t.startsWith("https://"))try{console.log("页面支持录音功能:",t)}catch(r){console.error("检查 content script 失败:",r)}}setInterval(async()=>{try{const e=await chrome.storage.local.get();console.log("当前存储使用情况:",Object.keys(e).length,"项")}catch(e){console.error("存储检查失败:",e)}},3e5);chrome.runtime.onSuspend.addListener(()=>{console.log("录音助手扩展即将暂停")});self.addEventListener("error",e=>{console.error("Background script 错误:",e.error)});self.addEventListener("unhandledrejection",e=>{console.error("Background script 未处理的 Promise 拒绝:",e.reason)});
